<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/base-layout.html}">
<head>
<title>Trang chủ</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Link CSS -->
<div layout:fragment="headerFiles">
	<link rel="stylesheet" href="/css/assets/light/apps/blog-post.css">
	<link rel="stylesheet" href="/css/assets/dark/apps/blog-post.css">
	<link rel="stylesheet"
		href="/css/assets/dark/apps/ecommerce-create.css">
	<link rel="stylesheet"
		href="/css/assets/light/apps/ecommerce-create.css">
	<link rel="stylesheet" type="text/css"
		href="/css/assets/dark/apps/blog-create.css">
	<link rel="stylesheet" type="text/css"
		href="/css/assets/light/apps/blog-create.css">

	<link rel="stylesheet" type="text/css"
		href="/css/plugins/light/tomSelect/custom-tomSelect.css">
	<link rel="stylesheet" type="text/css"
		href="/css/plugins/dark/tomSelect/custom-tomSelect.css">
	<link rel="stylesheet" type="text/css"
		href="/plugins/tomSelect/tom-select.default.min.css">

	<style>
.ts-control {
	padding: 12px;
}
.train-layout {
	display: flex;
	justify-content: center;
	gap: 20px;
	padding: 20px 0;
	width: 100%;
  overflow-x: auto; 
}

.carriage {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 10px;
	cursor: pointer;
	transition: transform 0.3s ease;
}

.carriage-content {
	position: relative;
	width: 100px;  
  	height: 50px; 
	border-radius: 10px;
	background-color: #ADD8E6; 
	box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
	display: flex;
	justify-content: center;
	align-items: center;
	padding: 10px 0;
}

.carriage-content:hover {
	transform: translateY(-5px);
	box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
	transition: transform 0.3s ease;
}

.carriage.selected .carriage-content {
	background-color: #28a745; 
	box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4); 
	transform: scale(1.1); 
}

.carriage.selected .carriage-label {
	color: #28a745; 
}


.windows {
	display: flex;
	justify-content: space-between;
	gap: 7px;
	width: 70%;
}

.window {
	width: 30px;
	height: 25px;
	background: #FFF;
	border-radius: 5px;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Nhãn Toa */
.carriage-label {
	font-weight: bold;
	font-size: 16px;
	color: #4CAF50;
	text-align: center;
	margin-top: 5px;
}

.seat-display {
	background: #f8f9fa;
	border-radius: 10px;
	padding: 20px;
	box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

.seat-map {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 15px;
	margin-top: 20px;
}

.seat-row {
	display: flex;
	gap: 10px;
}

.seat {
	width: 50px;
	height: 50px;
	background-color: #fff;
	color: #000;
	font-size: 14px;
	display: flex;
	justify-content: center;
	align-items: center;
	border-radius: 5px;
	cursor: pointer;
	border: 1px solid #999; 
	transition: background-color 0.3s, transform 0.2s;
}

.seat.selected {
	background-color: #007bff; 
	transform: scale(1.1); 
}

.seat:hover:not(.booked):not(.selected) {
	background-color: #ffc107;
	transform: scale(1.1); 
}

.seat.booked {
	background-color: #dc3545;
	cursor: not-allowed;
}

.btn-confirm {
	margin-top: 20px;
	padding: 12px 20px;
	font-size: 16px;
	font-weight: bold;
}
.seat-info {
    display: flex;
    justify-content: space-between; /* Đảm bảo phần tử con nằm trong cùng một dòng */
    align-items: center; /* Căn giữa theo chiều dọc */
    margin-bottom: 10px;
    padding: 10px;
    border-bottom: 1px solid #ddd;
}

.seat-details {
    flex-grow: 1; /* Phần thông tin ghế sẽ chiếm phần còn lại */
}

.delete-container {
    display: flex;
    align-items: center;
    justify-content: flex-end;
}

.delete-icon {
    margin-left: 10px;
    font-size: 18px;
    color: #ff0000; /* Màu đỏ cho biểu tượng thùng rác */
    cursor: pointer;
}

.delete-icon:hover {
    color: #cc0000; /* Thay đổi màu khi hover */
}


</style>

</div>


</head>
<body>
	<!-- Nội dung chính -->
	<div layout:fragment="content">
		<div class="middle-content container-xxl p-0">
			<!-- BREADCRUMB -->
			<div class="page-meta">
				<nav class="breadcrumb-style-one" aria-label="breadcrumb">
					<ol class="breadcrumb">
						<li class="breadcrumb-item"><a th:href="@{/dashboard/index}">Tra
								cứu</a></li>
						<li class="breadcrumb-item" aria-current="page">Danh sách
							chuyến đi</li>
						<li class="breadcrumb-item active" aria-current="page">Chi
							tiết chuyến đi</li>
					</ol>
				</nav>
			</div>
			<!-- /BREADCRUMB -->
			<div class="row layout-top-spacing">
				<div class="col-xxl-3 col-xl-3 col-lg-3 col-md-3 col-sm-12 mb-4">
					<div
						class="widget-content widget-content-area ecommerce-create-section">
						<div
							class="header text-center text-white mb-3 p-1 rounded border border-primary">
							<p class="mb-0 text-primary fs-4">Thông tin chuyến đi</p>
						</div>
						<div class="text-center mb-4">
							<img src="/images/van-tai-duong-sat.jpg" alt="Ship Image"
								class="img-fluid rounded" style="max-width: 100%;">
						</div>
						<div class="row">
							<div class="col-xxl-12">
								<div class="d-flex">
									<p class="text-start me-1">Tàu :</p>
									<b><p class="text-dark text-bold"
											th:text="${schedule != null ? schedule.route.train.trainName : ''}"></p></b>
								</div>
								<div class="d-flex">
									<p class="text-start me-1">Nơi đi :</p>
									<b><p class="text-dark text-bold"
											th:text="${schedule != null ? schedule.route.departureLocation.displayName : ''}"></p></b>
								</div>
								<div class="d-flex">
									<p class="text-start me-1">Nơi đến :</p>
									<b><p class="text-dark text-bold"
											th:text="${schedule != null ? schedule.route.destinationLocation.displayName  : ''}"></p></b>
								</div>
								<div class="d-flex">
									<p class="text-start me-1">Thời gian đi :</p>
									<b><p class="text-dark text-bold"
											th:text="${#temporals.format(schedule.departureDate, 'HH:mm, dd/MM/yyyy')}"></p></b>
								</div>
								<div class="d-flex">
									<p class="text-start me-1">Thời gian đến :</p>
									<b><p class="text-dark text-bold"
											th:text="${#temporals.format(schedule.estimateArrivalDate, 'HH:mm, dd/MM/yyyy')}"></p></b>
								</div>

							</div>
						</div>
					</div>
				</div>



				<div class="col-xxl-6 col-xl-6 col-lg-6 col-md-6 col-sm-12 mb-4">
					<div class="single-post-content">
						<div class="container">
							<h4 class="mb-4 text-center">Danh sách toa và ghế</h4>
							<hr>
							<div class="alert alert-info mt-4" role="alert">
								<div class="d-flex align-items-center">
									<i class="bi bi-info-circle-fill me-2 text-primary fs-5"></i>
									<p class="mb-0">
										<strong>Lưu ý:</strong> Nếu gặp khó khăn, hãy liên hệ tổng đài
										<strong>1800-1234</strong> để được hỗ trợ thêm.
									</p>
								</div>
							</div>


							<div class="train-layout d-flex justify-content-center gap-3">
								<div  th:each="coach, stat : ${coaches}">

									<div class="carriage" th:data-carriage="${coach.id}">
										<div class="carriage-content">
											<div class="windows">
												<div class="window"></div>
												<div class="window"></div>
												<div class="window"></div>
											</div>
										</div>
										<span class="carriage-label" th:text="${coach.coachName}"></span>
									</div>


								</div >

							</div>


							<!-- Ô lớn hiển thị ghế -->
							<div class="seat-display mt-4">
								<h5 id="carriage-title">Sơ đồ ghế: Toa 1</h5>
								<hr>
								<div class="d-flex justify-content-between align-items-center">
									<button class="btn btn-light-dark btn-sm" id="prevCarriage"><</button>
									<div class="seat-map" id="seat-map">
										<!-- Sơ đồ ghế sẽ được cập nhật qua JavaScript -->
									</div>
									<button class="btn btn-light-dark btn-sm" id="nextCarriage">></button>
								</div>
							</div>


						</div>

					</div>
				</div>



				<div class="col-xxl-3 col-xl-3 col-lg-3 col-md-3 col-sm-12 mb-4">
					<div class="widget-content widget-content-area ecommerce-create-section">
					    <div class="header text-center text-white mb-3 p-1 rounded border border-primary">
					        <p class="mb-0 text-primary fs-4">Giỏ vé</p>
					    </div>
					
					    <hr>
					    
					    <!-- Đây là phần hiển thị giỏ vé -->
					    <div id="cart-content">
					        <p>Giỏ vé trống!</p>
					    </div>
					
					    <hr>
					
					    <div class="d-flex justify-content-center">
					        <button class="btn btn-primary" id="confirmBooking">Mua vé</button>
					    </div>
					</div>


					<div
						class="widget-content widget-content-area ecommerce-create-section mt-3">
						<div
							class="header text-center text-white mb-3 p-1 rounded border border-primary">
							<p class="mb-0 text-primary fs-4">Tra cứu chuyến đi</p>
						</div>
						<form th:action="@{/schedule/index}" th:object="${searchSchedule}"
							method="post" id="general-settings">

							<div class="form-group mb-4">
								<label for="departureLocation">Nơi đi<strong
									class="text-danger">*</strong></label> <select
									th:field="*{departureLocation}" id="departureLocation"
									class="form-control"
									th:classappend="${#fields.hasErrors('departureLocation') ? 'is-invalid' : ''}">
									<option value="">Chọn nơi đi</option>
									<option th:each="province : ${provinces}"
										th:value="${province}" th:text="${province.displayName}"></option>
								</select> <span th:if="${#fields.hasErrors('departureLocation')}"
									class="text-danger" th:errors="*{departureLocation}"></span>
							</div>

							<div class="form-group mb-4">
								<label for="destination">Nơi đến<strong
									class="text-danger">*</strong></label> <select
									th:field="*{destinationLocation}" id="destinationLocation"
									class="form-control"
									th:classappend="${#fields.hasErrors('destinationLocation') ? 'is-invalid' : ''}">
									<option value="">Chọn nơi đến</option>
									<option th:each="province : ${provinces}"
										th:value="${province}" th:text="${province.displayName}"></option>
								</select> <span th:if="${#fields.hasErrors('destinationLocation')}"
									class="text-danger" th:errors="*{destinationLocation}"></span>
							</div>

							<div class="form-group mb-4">
								<label for="departureDate">Ngày đi<strong
									class="text-danger">*</strong></label> <input type="date"
									th:field="*{departureDate}" id="departureDate"
									name="departureDate" class="form-control"
									placeholder="Chọn ngày bắt đầu"
									th:classappend="${#fields.hasErrors('departureDate') ? 'is-invalid' : ''}"
									required> <span
									th:if="${#fields.hasErrors('departureDate')}"
									class="text-danger" th:errors="*{departureDate}"></span>
							</div>

							<div class="d-flex justify-content-center">
								<button type="submit" class="btn btn-primary">Tìm kiếm</button>
							</div>
						</form>


					</div>
				</div>


			</div>


			<div class="col-xxl-12 col-xl-12 col-lg-12 col-md-12 col-sm-12 mb-4">
				<div class="single-post-content">

					<div
						class="header text-center text-white p-1 rounded border border-primary">
						<p class="mb-0 text-primary fw-bold fs-2">QUY ĐỊNH ĐỔI, TRẢ VÉ</p>
					</div>

					<div class="post-content">

						<h4 class="mb-3">1. Thời gian cao điểm Tết: Mức khấu trừ đối
							với vé trả lại, đổi vé là 30% giá tiền in trên Thẻ lên tàu hỏa
							(vé).</h4>

						<p>- Từ ngày 21/01/2025 đến ngày 31/01/2025: đối với đoàn tàu
							số chẵn.</p>
						<p>- Từ ngày 01/02/2025 đến ngày 09/02/2025: đối với đoàn tàu
							số lẻ.</p>
						<p>(*) Thời gian đổi, trả vé</p>
						<p>- Hành khách đổi, trả vé cá nhân: chậm nhất trước giờ tàu
							chạy là 24 giờ.</p>
						<p class="mb-3">- Hành khách trả vé tập thể: chậm nhất trước
							giờ tàu chạy là 48 giờ.</p>

						<h4 class="mb-3">2. Ngoài thời gian quy định tại điểm (1.)
							nêu trên, mức khấu trừ phí, thời gian đổi, trả vé thực hiện như
							sau:</h4>

						<p>- Từ ngày 21/01/2025 đến ngày 31/01/2025: đối với đoàn tàu
							số chẵn.</p>
						<p>- Từ ngày 01/02/2025 đến ngày 09/02/2025: đối với đoàn tàu
							số lẻ.</p>
						<p>(*) Thời gian đổi, trả vé</p>
						<p>- Hành khách đổi, trả vé cá nhân: chậm nhất trước giờ tàu
							chạy là 24 giờ.</p>
						<p class="mb-3">- Hành khách trả vé tập thể: chậm nhất trước
							giờ tàu chạy là 48 giờ.</p>

						<h4 class="mb-3">3. Hình thức trả vé.</h4>

						<p>- Khi hành khách mua vé và thanh toán online qua website
							bán vé của Ngành Đường sắt, app bán vé hoặc các ứng dụng mua vé
							tàu hỏa của các đối tác thứ ba thì có thể trả vé online qua các
							website bán vé của Ngành Đường sắt hoặc đến trực tiếp nhà ga.</p>
						<p>- Khi hành khách mua vé bằng các hình thức khác, muốn đổi
							vé, trả vé hành khách đến trực tiếp nhà ga kèm theo giấy tờ tùy
							thân bản chính của người đi tàu (hoặc người mua vé) cho nhân viên
							đường sắt. Đồng thời, thông tin trên thẻ đi tàu phải trùng khớp
							với giấy tờ tùy thân của hành khách.</p>
						<p class="mb-3">Trân trọng cảm ơn!.</p>

					</div>

				</div>

			</div>
		</div>
	</div>

	<!-- Scripts -->
	<div layout:fragment="footerFiles">
		<script src="/plugins/tomSelect/tom-select.base.js"></script>
		<script src="/plugins/flatpickr/flatpickr.js"></script>
		<script src="/plugins/tomSelect/custom-tom-select.js"></script>
		<script>
			const today = new Date();
			const tomorrow = new Date(today);
			tomorrow.setDate(tomorrow.getDate() + 1);
			
			const formattedDate = tomorrow.toISOString().split('T')[0];
			
			document.getElementById("departureDate").setAttribute("min", formattedDate);
		</script>

	<script type="text/javascript">
	    function initializeTomSelect(selector) {
	        new TomSelect(selector, {
	            create: true,
	            sortField: {
	                field: "text",
	                direction: "asc"
	            }
	        });
	    }
	
	    initializeTomSelect("#departureLocation");
	    initializeTomSelect("#destinationLocation");
	</script>


		<script th:inline="javascript">
		    /*<![CDATA[*/
		    var schedule = /*[[${schedule}]]*/ {};
		    /*]]>*/
		</script>

		<script>
			$(document).ready(function () {
			    let currentCarriage = 1;
	
			    function fetchSeats(carriageNumber) {
			        $.ajax({
			            url: `/seat/list/${carriageNumber}`,
			            method: 'GET',
			            success: function (data) {
			                displaySeats(data, carriageNumber);
			                console.log("test", data);
			            },
			            error: function () {
			                alert("Không thể tải danh sách ghế. Vui lòng thử lại.");
			            }
			        });
			    }
	
			    function displaySeats(seats, carriageNumber) {
			        const $seatMap = $('#seat-map');
			        const $carriageTitle = $('#carriage-title');
	
			        $carriageTitle.text(`Sơ đồ ghế: Toa ${carriageNumber}`);
			        $seatMap.empty();
			        const rows = [];
			        for (let i = 0; i < seats.length; i += 7) {
			            rows.push(seats.slice(i, i + 7));
			        }
	
			        rows.slice(0, 2).forEach((row, rowIndex) => {
			            const $rowDiv = $('<div>').addClass('seat-row');
			            row.forEach((seat, seatIndex) => {
			                const $seatDiv = $('<div>').addClass('seat').addClass(seat.seatType.status === 'ENABLE' ? 'available' : 'booked');
			                const seatNumber = rowIndex * 7 + seatIndex + 1;
			                $seatDiv.text(seatNumber);
			                
			                $seatDiv.attr('data-seat-id', seat.id);
			                $seatDiv.data('seatId', seat.id)
			                    .data('coachId', seat.coach.id)
			                    .data('trainId', seat.coach.train.id)
			                    .data('seatName', seat.seatName)
			                    .data('coachName', seat.coach.coachName)
			                    .data('trainName', seat.coach.train.trainName)
			                    .data('price', seat.seatType.price);
	
			                if (schedule) {
			                    $seatDiv.data('departureLocation', schedule.route.departureLocation)
			                        .data('destinationLocation', schedule.route.destinationLocation)
			                        .data('departureDate', schedule.departureDate)
			                        .data('scheduleId', schedule.id);
			                }
	
			                if (seat.seatType.status === 'ENABLE') {
			                    $seatDiv.on('click', function () {
			                        $seatDiv.toggleClass('selected');
	
			                        const seatData = {
			                            seatId: $seatDiv.data('seatId'),
			                            seatName: $seatDiv.data('seatName'),
			                            coachId: $seatDiv.data('coachId'),
			                            coachName: $seatDiv.data('coachName'),
			                            trainId: $seatDiv.data('trainId'),
			                            trainName: $seatDiv.data('trainName'),
			                            price: $seatDiv.data('price'),
			                            scheduleId: $seatDiv.data('scheduleId'),
			                            departureLocation: $seatDiv.data('departureLocation'),
			                            destinationLocation: $seatDiv.data('destinationLocation'),
			                            departureDate: $seatDiv.data('departureDate')
			                        };
	
			                        let selectedSeats = JSON.parse(localStorage.getItem('selectedSeats')) || [];
			                        if ($seatDiv.hasClass('selected')) {
			                            selectedSeats.push(seatData);
			                        } else {
			                            selectedSeats = selectedSeats.filter(seat => seat.seatId !== $seatDiv.data('seatId'));
			                        }
	
			                        localStorage.setItem('selectedSeats', JSON.stringify(selectedSeats));
			                        updateCart();
			                    });
			                }
	
			                $rowDiv.append($seatDiv);
			            });
	
			            $seatMap.append($rowDiv);
			        });
			    }
	
			    $('.carriage').on('click', function () {
			        const carriageNumber = $(this).data('carriage');
	
			        $('.carriage').removeClass('selected');
			        $(this).addClass('selected');
			        fetchSeats(carriageNumber);
			        currentCarriage = carriageNumber;
			    });
	
			    $('#prevCarriage').on('click', function () {
			        if (currentCarriage > 1) {
			            currentCarriage--;
			            fetchSeats(currentCarriage);
			            $('.carriage').removeClass('selected');
			            $(`.carriage[data-carriage="${currentCarriage}"]`).addClass('selected');
			        }
			    });
	
			    $('#nextCarriage').on('click', function () {
			        if (currentCarriage < $('.carriage').length) {
			            currentCarriage++;
			            fetchSeats(currentCarriage);
			            $('.carriage').removeClass('selected');
			            $(`.carriage[data-carriage="${currentCarriage}"]`).addClass('selected');
			        }
			    });
	
			    fetchSeats(1);
	
			    function updateCart() {
			        const $cartContent = $('#cart-content');
			        const selectedSeats = JSON.parse(localStorage.getItem('selectedSeats')) || [];
			        $cartContent.empty();
			        if (selectedSeats.length === 0) {
			            $cartContent.html('<p>Giỏ vé trống!</p>');
			            return;
			        }
	
			        let totalPrice = 0;
			        selectedSeats.forEach(seat => {
			            const $seatInfoDiv = $('<div>').addClass('seat-info');
	
			            const dateObj = new Date(seat.departureDate);
			            const formattedDate = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')} | ` +
			                `${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/${dateObj.getDate().toString().padStart(2, '0')}/` +
			                `${dateObj.getFullYear()}`;
	
			            const $deleteIcon = $('<span>').addClass('delete-icon').html('🗑️').css('cursor', 'pointer');
	
			            $deleteIcon.on('click', function () {
			                const updatedSeats = selectedSeats.filter(item => item.seatId !== seat.seatId);
			                localStorage.setItem('selectedSeats', JSON.stringify(updatedSeats));
			                updateCart();
	
			                const $seatDiv = $(`.available[data-seat-id="${seat.seatId}"]`);
			                console.log("test", seat.seatId);
			                if ($seatDiv.length) {
			                    $seatDiv.removeClass('selected');
			                }
			            });
	
			            const $seatDetailsDiv = $('<div>').addClass('seat-details')
			                .html(`
			                    <p><strong>Tàu: </strong>${seat.trainName} ${seat.departureLocation} - ${seat.destinationLocation}</p>
			                    <p><strong>Ngày đi: </strong>${formattedDate}</p>
			                    <p><strong>NML: </strong>${seat.coachName}  Ghế: ${seat.seatId}</p>
			                `);
	
			            const $deleteContainer = $('<div>').addClass('delete-container').append($deleteIcon);
			            $seatInfoDiv.append($seatDetailsDiv).append($deleteContainer);
			            $cartContent.append($seatInfoDiv);
			            totalPrice += parseFloat(seat.price);
			        });
	
			        const $seatCountDiv = $('<div>').addClass('seat-count').html(`<p><strong>Số ghế đã chọn: </strong>${selectedSeats.length}</p>`);
			        $cartContent.append($seatCountDiv);
			    }
	
			   
	
			    $('#confirmBooking').on('click', function () {
			        const selectedSeats = JSON.parse(localStorage.getItem('selectedSeats')) || [];
			        if (selectedSeats.length === 0) {
			            alert('Vui lòng chọn ít nhất một ghế để mua vé!');
			            return;
			        }
			        localStorage.setItem('selectedSeats', JSON.stringify(selectedSeats));
			        window.location.href = '/instruct/index';
			    });
			});
			
			 window.onload = function () {  	
		        localStorage.removeItem('selectedSeats');
		        updateCart();
		    };

		</script>

	</div>
</body>
</html>